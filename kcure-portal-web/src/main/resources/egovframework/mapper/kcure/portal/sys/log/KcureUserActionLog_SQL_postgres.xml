<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="KcureUserActionLog">

	<!-- 시스템로그 맵 -->
	<resultMap id="UserActionLogVo" type="kcure.portal.sys.log.ulg.service.UserActionLog">
		<result property="requstId" column="REQUST_ID"/>
		<result property="occrrncDe" column="OCCRRNC_DE"/>
		<result property="srvcNm" column="SVC_NM"/>
		<result property="methodNm" column="METHOD_NM"/>
		<result property="processSeCode" column="PROCESS_SE_CODE"/>
		<result property="processSeCodeNm" column="PROCESS_SE_CODE_NM"/>
		<result property="processTime" column="PROCESS_TIME"/>
		<result property="rqesterIp" column="RQESTER_IP"/>
		<result property="rqesterId" column="RQESTER_ID"/>
		<result property="rqsterNm" column="RQESTER_NM"/>
		<result property="menuUriAddr" column="MENU_URI_ADDR"/>
		<result property="trgetMenuNm" column="TRGET_MENU_NM"/>
	</resultMap>
	
<!-- 시스템 로그 등록 'LOG'||TO_CHAR(NOW(),'YYYYMMDDHH24MISSMS') -->
	<insert id="logInsertSysLog_backup" parameterType="kcure.portal.sys.log.ulg.service.UserActionLog">
		
		<![CDATA[
			INSERT INTO KCURE_COM_COMTNSYSLOG 
				( REQUST_ID
				  , SVC_NM
				  , METHOD_NM
				  , PROCESS_SE_CODE
				  , PROCESS_TIME
				  , RQESTER_ID
				  , RQESTER_IP
				  , OCCRRNC_DE 
				  , MENU_URI_ADDR
				  , TRGET_MENU_NM
				  )
			VALUES ( 
					 #{requstId}
				  , #{srvcNm}
				  , #{methodNm}
				  , #{processSeCode}
				  , #{processTime}
				  , #{rqesterId}
				  , #{rqesterIp}
				  , NOW()
				  , #{menuUriAddr}
				  , (SELECT RS.MENU_NM
					FROM (
						SELECT A.MENU_NM,
							CASE  WHEN POSITION( A.MENU_URI_PATT_CONT IN C.URI) >0  THEN 'Y' ELSE 'N' END  CHECK_URI
						FROM KCURE_COM_MENU A
							,(SELECT #{menuUriAddr} AS URI) C
						WHERE A.MENU_USE_YN = 'Y'
						AND A.MENU_URI_PATT_CONT IS NOT NULL 
						AND A.MENU_URI_PATT_CONT !=''
						) RS
					WHERE RS.CHECK_URI = 'Y' )
				  )
		]]>
	</insert>
	<!-- 시스템 로그 등록 'LOG'||TO_CHAR(NOW(),'YYYYMMDDHH24MISSMS') -->
	<insert id="logInsertSysLog" parameterType="kcure.portal.sys.log.ulg.service.UserActionLog">
		
		<![CDATA[
		WITH UPQRY AS (
               UPDATE KCURE_COM_COMTNSYSLOG
                 SET SVC_NM = #{srvcNm}
                 	,METHOD_NM = #{methodNm}
                 	,PROCESS_SE_CODE = #{processSeCode}
                 	,PROCESS_TIME = #{processTime}
                 	,RQESTER_ID = #{rqesterId}
                 	,RQESTER_IP = #{rqesterIp}
                 	,OCCRRNC_DE = NOW()
                 	,MENU_URI_ADDR = #{menuUriAddr}
                 	,TRGET_MENU_NM = (SELECT RS.MENU_NM
								FROM (
									SELECT A.MENU_NM,
										CASE  WHEN POSITION( A.MENU_URI_PATT_CONT IN C.URI) >0  THEN 'Y' ELSE 'N' END  CHECK_URI
									FROM KCURE_COM_MENU A
										,(SELECT #{menuUriAddr} AS URI) C
									WHERE A.MENU_USE_YN = 'Y'
									AND A.MENU_URI_PATT_CONT IS NOT NULL 
									AND A.MENU_URI_PATT_CONT !=''
									) RS
								WHERE RS.CHECK_URI = 'Y' )
                WHERE REQUST_ID = #{requstId}
               RETURNING *
             )
    	INSERT INTO KCURE_COM_COMTNSYSLOG 
				( REQUST_ID
				  , SVC_NM
				  , METHOD_NM
				  , PROCESS_SE_CODE
				  , PROCESS_TIME
				  , RQESTER_ID
				  , RQESTER_IP
				  , OCCRRNC_DE 
				  , MENU_URI_ADDR
				  , TRGET_MENU_NM
				  )
		SELECT 
			 #{requstId}
				  , #{srvcNm}
				  , #{methodNm}
				  , #{processSeCode}
				  , #{processTime}
				  , #{rqesterId}
				  , #{rqesterIp}
				  , NOW()
				  , #{menuUriAddr}
				  , (SELECT RS.MENU_NM
					FROM (
						SELECT A.MENU_NM,
							CASE  WHEN POSITION( A.MENU_URI_PATT_CONT IN C.URI) >0  THEN 'Y' ELSE 'N' END  CHECK_URI
						FROM KCURE_COM_MENU A
							,(SELECT #{menuUriAddr} AS URI) C
						WHERE A.MENU_USE_YN = 'Y'
						AND A.MENU_URI_PATT_CONT IS NOT NULL 
						AND A.MENU_URI_PATT_CONT !=''
						) RS
					WHERE RS.CHECK_URI = 'Y' )
		 WHERE NOT EXISTS (SELECT * FROM UPQRY)
		]]>
	</insert>
	<!-- #{trgetMenuNm} -->
	
	<sql id="selectSql_col" >
		<![CDATA[
			SELECT 
				  A.REQUST_ID
				, A.OCCRRNC_DE
				, A.SVC_NM
				, A.METHOD_NM
				, A.PROCESS_SE_CODE
				, C.DETL_CD_NM AS PROCESS_SE_CODE_NM
				, A.PROCESS_TIME
				, A.RQESTER_IP
				, A.RQESTER_ID
				, A.MENU_URI_ADDR
				, A.TRGET_MENU_NM
				, B.USER_NM AS RQESTER_NM
			]]>
			
	</sql>
	
	<sql id="selectSql_from" >
		<![CDATA[
			FROM
				KCURE_COM_COMTNSYSLOG A
			LEFT OUTER JOIN KCURE_COM_USER  B
				ON A.RQESTER_ID = B.USER_ID
			LEFT OUTER JOIN KCURE_COM_CD  C
				ON A.PROCESS_SE_CODE = C.DETL_CD
			WHERE 
				C.GRP_CD = 'USER_LOG_TPCD'
			]]>
	</sql>
	
	<sql id="selectWhere" >
		<if test="searchType != null and searchType != ''">	
		<![CDATA[	AND A.PROCESS_SE_CODE =  #{searchType} ]]>
		</if>
		<if test="searchBgnDe != null and searchBgnDe != ''">	
		<![CDATA[	
			AND A.OCCRRNC_DE BETWEEN TO_TIMESTAMP(CONCAT(#{searchBgnDe},' 00:00:00'), 'YYYY-mm-dd HH24:MI:SS') 
			AND TO_TIMESTAMP(CONCAT(#{searchEndDe},' 23:59:59'), 'YYYY-mm-dd HH24:MI:SS') 
		]]>
		</if>
		<if test="searchId != null and searchId != ''">	
		<![CDATA[	AND A.RQESTER_ID  LIKE CONCAT ('%', #{searchId},'%') ]]>
		</if>
	</sql>

	<!-- 시스템 로그 목록 조회 -->
	<select id="selectUserActionLogInf" parameterType="kcure.portal.sys.log.ulg.service.UserActionLog" resultMap="UserActionLogVo">
		<include refid="selectSql_col" />
		<include refid="selectSql_from" />
		<include refid="selectWhere" />
		<![CDATA[ 
			ORDER BY A.OCCRRNC_DE DESC
			LIMIT #{recordCountPerPage} OFFSET #{firstIndex}
		]]>
	</select>

	<!-- 시스템 로그 총건수 -->
	<select id="selectUserActionLogInfCnt" parameterType="kcure.portal.sys.log.ulg.service.UserActionLog" resultType="int">
		<![CDATA[
			SELECT COUNT(A.REQUST_ID) AS CNT
		]]>
		<include refid="selectSql_from" />
		<include refid="selectWhere" />
		
	</select>
</mapper>